<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
    <script type="text/javascript">

        const global_client_id = "rtgvfRcGt3nfOTH1mVuZ";
        const global_client_secret = "tjfTeXkquy";

        function getUUID() {
            function s4() {
                return ((1 + Math.random()) * 0x10000 | 0).toString(16).substring(1);
            }
            return s4() + s4() + '-' + s4() + '-' + s4() + '-' + s4() + '-' + s4() + s4() + s4();
        }

        function pageLog(log_data) {

            document.getElementById("logArea").innerHTML = document.getElementById("logArea").innerHTML + log_data + "<br>";
        }

        $(document).ready(function () {
            let tempString = location.search;
            let find_function = "function=";

            if (tempString.indexOf(find_function) != -1) {

                let program_function = tempString.substring(tempString.indexOf(find_function) + find_code.length);

                switch (program_function) {
                    case login:

                        break;
                    case get_token:

                        break;
                    case delete_token:

                        break;
                }
            }
        });


        $(document).on('mouseup', '#loginButton', function () {

            login();

        });

        $(document).on('mouseup', '#loginAuthButton', function () {

            get_token();

        });

        $(document).on('mouseup', '#loginTokenDeleteButton', function () {

            delete_token();

        });

        $(document).on('mouseup', '#testButton', function () {
            //let tempString = "?code=QDQoKuGx6EdsHU7OSM&state=e77eefd0-0b2f-d754-bb5f-4890e6e71a38";
            let tempString = "?state=e77eefd0-0b2f-d754-bb5f-4890e6e71a38%error=QDQoKuGx6EdsHU7OSM&error_description=123ff123d123";


        });

        function login() {

            let login_url = "https://nid.naver.com/oauth2.0/authorize";

            let response_type = "code";
            let client_id = global_client_id;
            let redirect_uri = encodeURI("https://ap0000114.github.io/web3/index.html", "UTF-8");
            let state = getUUID();

            login_url = login_url +
                "?response_type=" + response_type +
                "&client_id=" + client_id +
                "&redirect_uri=" + redirect_uri +
                "&state=" + state;

            window.location.href = login_url;
        }

        function get_token() {

            pageLog("콜백 데이터  : [" + location.href + "]");

            let tempString = location.search;

            let find_code = "code=";
            let find_state = "state=";
            let find_error = "error=";
            let find_error_description = "error_description=";

            let code = "";
            let state = "";
            let error = "";
            let error_description = "";

            if (tempString.indexOf(find_code) != -1) {
                code = tempString.substring(tempString.indexOf(find_code) + find_code.length);

                if (code.indexOf("&") != -1) {
                    code = code.substring(0, code.indexOf("&"));
                }
            } else {
                pageLog(find_code + " is not found");
            }

            if (tempString.indexOf(find_state) != -1) {
                state = tempString.substring(tempString.indexOf(find_state) + find_state.length);

                if (state.indexOf("&") != -1) {
                    state = state.substring(0, state.indexOf("&"));
                }
            } else {
                pageLog(find_state + " is not found");
            }

            if (tempString.indexOf(find_error) != -1) {
                error = tempString.substring(tempString.indexOf(find_error) + find_error.length);

                if (error.indexOf("&") != -1) {
                    error = error.substring(0, error.indexOf("&"));
                }
            } else {
                pageLog(find_error + " is not found");
            }

            if (tempString.indexOf(find_error_description) != -1) {
                error_description = tempString.substring(tempString.indexOf(find_error_description) + find_error_description.length);

                if (error_description.indexOf("&") != -1) {
                    error_description = error_description.substring(0, error_description.indexOf("&"));
                }
            } else {
                pageLog(find_error_description + " is not found");
            }

            pageLog("code : [" + code + "]");
            pageLog("state : [" + state + "]");
            pageLog("error : [" + error + "]");
            pageLog("error_description : [" + error_description + "]");


            let login_url = "https://nid.naver.com/oauth2.0/token";

            let grant_type = "authorization_code";
            let client_id = global_client_id;
            let client_secret = global_client_secret;
            let code_url = code;
            let state_url = state;

            let refresh_token = "";
            let access_token = "";
            let service_provider = "";

            login_url = login_url +
                "?grant_type=" + grant_type +
                "&client_id=" + client_id +
                "&client_secret=" + client_secret +
                "&code=" + code_url +
                "&state=" + state_url;

            pageLog(login_url);
            window.prompt("msg", login_url);

            let xhttp = new XMLHttpRequest();
            xhttp.onreadystatechange = (e) => {
                let req = e.target;
                
                // 통신 상태가 완료가 되면.
                if (req.readyState === XMLHttpRequest.DONE) {

                    // Http response 응답코드가 200(정상)이면
                    if (req.status === 200) {

                        pageLog(req.response);
                        pageLog(req.responseText);
                    }
                }
            }
            // http 요청 타입과 주소, 동기식 여부
            xhttp.open("GET", login_url, true);
            xhttp.send();
        }

        function delete_token() {

            let login_url = "https://nid.naver.com/oauth2.0/authorize";

            let grant_type = "delete";
            let client_id = global_client_id;
            let client_secret = global_client_secret;
            let access_token = "";
            let service_provider = "NAVER";

            login_url = login_url +
                "?grant_type=" + grant_type +
                "&client_id=" + client_id +
                "&client_secret=" + client_secret +
                "&access_token=" + access_token +
                "&service_provider=" + service_provider;

            let xhttp = new XMLHttpRequest();
            xhttp.onreadystatechange = (e) => {
                let req = e.target;
                
                // 통신 상태가 완료가 되면.
                if (req.readyState === XMLHttpRequest.DONE) {

                    // Http response 응답코드가 200(정상)이면
                    if (req.status === 200) {

                        pageLog(req.response);
                        pageLog(req.responseText);
                    }
                }
            }
            // http 요청 타입과 주소, 동기식 여부
            xhttp.open("GET", "test.json", true);
            //xhttp.send();
        }




    </script>


</head>

<body>

    <input type="button" id="loginButton" value="loginButton" />
    <input type="button" id="loginAuthButton" value="loginAuthButton" />
    <input type="button" id="loginTokenDeleteButton" value="loginTokenDeleteButton" />
    <input type="button" id="testButton" value="testButton" />
    <br>
    access_token = [<div id="access_token"></div>] <br>
    refresh_token = [<div id="refresh_token"></div>] <br>
    token_type = [<div id="token_type"></div>] <br>
    expires_in = [<div id="expires_in"></div>] <br>
    <br>
    <div id="logArea"></div>

</body>

</html>
